<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒƒã‚­åˆ¥å‹ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼ (éŠæˆ¯ç‹MD)</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDNã‚’èª­ã¿è¾¼ã¿ (ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’å„ªå…ˆ */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f7f7f7;
        }
        .card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-record {
            background-color: #4f46e5; /* ã‚¤ãƒ³ãƒ‡ã‚£ã‚´ */
            border: 2px solid #4338ca;
            transition: all 0.15s;
        }
        .btn-record:hover {
            background-color: #4338ca;
            transform: scale(1.02);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Chart.jsã®ã‚³ãƒ³ãƒ†ãƒŠãŒè¦ªè¦ç´ ã«å¯¾ã—ã¦é©åˆ‡ã«ã‚µã‚¤ã‚ºå¤‰æ›´ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        .chart-container {
            max-width: 100%;
            height: 384px; /* ã‚°ãƒ©ãƒ•ã®é«˜ã•å›ºå®š */
            display: flex; /* ã‚°ãƒ©ãƒ•ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã« flex ã‚’ä½¿ç”¨ */
            justify-content: center;
            align-items: center;
        }
        /* ã‚°ãƒ©ãƒ•ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ */
        .tab-active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: bold;
        }
    </style>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="w-full max-w-lg">
        <div class="card bg-white p-8 rounded-xl space-y-8">
            <h1 class="text-4xl font-bold text-center text-gray-800">ãƒ‡ãƒƒã‚­åˆ¥å‹ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼ (éŠæˆ¯ç‹MDå¯¾å¿œ)</h1>
            <p id="auth-status" class="text-center text-sm text-gray-500">èªè¨¼ä¸­...</p>
            
            <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="app-message" style="display:none;" class="p-3 rounded-lg text-sm transition-all duration-300"></div>

            <!-- ãƒ‡ãƒƒã‚­é¸æŠã¨è¿½åŠ ã‚¨ãƒªã‚¢ -->
            <div class="space-y-3">
                <label for="deck-select" class="block text-sm font-medium text-gray-700">ç¾åœ¨ã®ãƒ‡ãƒƒã‚­</label>
                <div class="flex space-x-2">
                    <select id="deck-select" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white" disabled>
                        <option value="">ãƒ‡ãƒƒã‚­ã‚’é¸æŠã¾ãŸã¯è¿½åŠ ã—ã¦ãã ã•ã„</option>
                    </select>
                    <button id="add-deck-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50" disabled>
                        <span class="text-xl">+</span>
                    </button>
                </div>
            </div>
            
            <!-- å…¨ä½“ã®çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ (å…¨ãƒ‡ãƒƒã‚­ã®åˆç®—) -->
            <div class="p-4 bg-gray-100 rounded-xl space-y-2 border border-gray-300">
                <h2 class="text-lg font-bold text-gray-700 text-center">ğŸ† å…¨ä½“çµ±è¨ˆ (å…¨ãƒ‡ãƒƒã‚­ã®åˆç®—)</h2>
                <div class="grid grid-cols-3 gap-2 text-center text-sm">
                    <div class="p-1 bg-white rounded">
                        <p class="text-xs text-gray-500">W/L</p>
                        <p id="global-wl-display" class="font-bold text-gray-800">0/0</p>
                    </div>
                    <div class="p-1 bg-white rounded">
                        <p class="text-xs text-gray-500">åˆè¨ˆ</p>
                        <p id="global-total-display" class="font-bold text-gray-800">0</p>
                    </div>
                    <div class="p-1 bg-white rounded bg-yellow-50">
                        <p class="text-xs text-yellow-800 font-semibold">å…¨ä½“å‹ç‡</p>
                        <p id="global-win-rate-display" class="text-xl font-extrabold text-yellow-600">0.00%</p>
                    </div>
                </div>
            </div>
            
            <!-- ã‚³ã‚¤ãƒ³ãƒˆã‚¹åˆ¥çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="coin-stats-area" class="p-4 bg-yellow-50 rounded-xl space-y-3 border border-yellow-200 transition-opacity duration-300 opacity-50 pointer-events-none">
                <h2 class="text-lg font-bold text-yellow-700 text-center">ğŸª™ ã‚³ã‚¤ãƒ³ãƒˆã‚¹åˆ¥å‹ç‡ (é¸æŠä¸­ãƒ‡ãƒƒã‚­)</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <!-- å‹åˆ©æ™‚ -->
                    <div class="p-3 bg-white rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">å‹åˆ©æ™‚å‹ç‡</p>
                        <p id="coin-win-rate-display" class="text-2xl font-extrabold text-green-600 mt-1">0.00%</p>
                        <p id="coin-win-wl-display" class="text-xs text-gray-500 mt-1">0W / 0L</p>
                    </div>
                    <!-- æ•—åŒ—æ™‚ -->
                    <div class="p-3 bg-white rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">æ•—åŒ—æ™‚å‹ç‡</p>
                        <p id="coin-loss-rate-display" class="text-2xl font-extrabold text-red-600 mt-1">0.00%</p>
                        <p id="coin-loss-wl-display" class="text-xs text-gray-500 mt-1">0W / 0L</p>
                    </div>
                </div>
            </div>

            <!-- å…ˆè¡Œ/å¾Œæ”»çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="first-second-stats" class="p-4 bg-indigo-50 rounded-xl space-y-3 border border-indigo-200 transition-opacity duration-300 opacity-50 pointer-events-none">
                <h2 class="text-lg font-bold text-indigo-700 text-center">âš”ï¸ é¸æŠã—ãŸè¡Œå‹• (å…ˆè¡Œ/å¾Œæ”») å‹ç‡ (é¸æŠä¸­ãƒ‡ãƒƒã‚­)</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-3 bg-white rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">å…ˆè¡Œå‹ç‡ (1st Win Rate)</p>
                        <p id="first-win-rate-display" class="text-2xl font-extrabold text-blue-600 mt-1">0.00%</p>
                        <p id="first-wl-display" class="text-xs text-gray-500 mt-1">0W / 0L</p>
                    </div>
                    <!-- ä¿®æ­£: å¾Œæ”»å‹ç‡ã®è¡¨ç¤º -->
                    <div class="p-3 bg-white rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">å¾Œæ”»å‹ç‡ (2nd Win Rate)</p>
                        <p id="second-win-rate-display" class="text-2xl font-extrabold text-red-600 mt-1">0.00%</p>
                        <p id="second-wl-display" class="text-xs text-gray-500 mt-1">0W / 0L</p>
                    </div>
                </div>
            </div>


            <!-- é¸æŠä¸­ã®ãƒ‡ãƒƒã‚­çµ±è¨ˆè¡¨ç¤º -->
            <div id="stats-area" class="space-y-4 transition-opacity duration-300 opacity-50 pointer-events-none">
                <p class="text-2xl font-bold text-center text-indigo-700" id="current-deck-name">ãƒ‡ãƒƒã‚­ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

                <div class="grid grid-cols-2 gap-4 text-center border-t border-b py-4">
                    <!-- å‹åˆ©æ•° -->
                    <div class="p-3 bg-green-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">å‹åˆ©æ•° (W)</p>
                        <p id="wins-display" class="text-4xl font-extrabold text-green-600 mt-1">0</p>
                    </div>
                    <!-- æ•—åŒ—æ•° -->
                    <div class="p-3 bg-red-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-600">æ•—åŒ—æ•° (L)</p>
                        <p id="losses-display" class="text-4xl font-extrabold text-red-600 mt-1">0</p>
                    </div>
                </div>

                <div class="text-center space-y-4">
                    <!-- å‹ç‡è¡¨ç¤º -->
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <p class="text-sm font-semibold text-blue-800">ã“ã®ãƒ‡ãƒƒã‚­ã®å…¨ä½“å‹ç‡ (Win Rate)</p>
                        <p id="win-rate-display" class="text-5xl font-extrabold text-blue-600 mt-1">0.00%</p>
                    </div>

                    <!-- åˆè¨ˆè©¦åˆæ•° -->
                    <p class="text-lg font-medium text-gray-700">åˆè¨ˆè©¦åˆæ•°: <span id="total-games-display" class="font-bold text-xl text-indigo-600">0</span></p>
                </div>
                
                <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
                <div class="flex pt-4">
                    <button id="open-charts-modal-btn" class="w-full py-3 text-white text-lg font-bold rounded-xl bg-purple-500 hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 disabled:opacity-50" disabled>
                        <span class="mr-2">ğŸ“ˆ</span> ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºãƒ»åˆ†æ
                    </button>
                </div>

                <!-- æ“ä½œãƒœã‚¿ãƒ³: è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã -->
                <div class="flex">
                    <button id="open-record-modal-btn" class="btn-record w-full py-4 text-white text-xl font-bold rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:opacity-50" disabled>
                        <span class="text-2xl mr-2">âœï¸</span> è©¦åˆçµæœã‚’è¨˜éŒ²
                    </button>
                </div>

                <!-- å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã‚¨ãƒªã‚¢ (ãƒªã‚¹ãƒˆè¡¨ç¤ºã¯æ®‹ã™) -->
                <div class="p-4 bg-purple-50 rounded-xl space-y-3 border border-purple-200">
                    <h3 class="text-xl font-bold text-purple-700 text-center">âš”ï¸ å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ (ãƒªã‚¹ãƒˆ)</h3>
                    <div id="opponent-stats-list" class="space-y-2">
                        <!-- ã“ã“ã«å¯¾æˆ¦ç›¸æ‰‹ã”ã¨ã®çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        <p class="text-center text-gray-500 text-sm">è¨˜éŒ²ã•ã‚ŒãŸè©¦åˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
                
                <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                <div class="text-center">
                    <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-full text-sm disabled:opacity-50" disabled>
                        ã“ã®ãƒ‡ãƒƒã‚­ã®è¨˜éŒ²ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
            <p class="text-xs text-gray-400 mt-4 break-all">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="user-id-display">N/A</span></p>
        </div>
    </div>

    <!-- ãƒ‡ãƒƒã‚­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« (MODAL 1) -->
    <div id="deck-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm space-y-4">
            <h3 class="text-xl font-bold text-gray-800">æ–°ã—ã„ãƒ‡ãƒƒã‚­ã®è¿½åŠ </h3>
            <input type="text" id="new-deck-name-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ‡ãƒƒã‚­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: èµ¤å˜ã‚¢ã‚°ãƒ­)">
            <div id="deck-name-error" class="text-red-500 text-sm hidden">ãƒ‡ãƒƒã‚­åã¯å¿…é ˆã§ã™ã€‚</div>
            <div class="flex justify-end space-x-3">
                <button id="deck-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="deck-modal-add-btn" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 disabled:opacity-50" disabled>è¿½åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« (MODAL 2) -->
    <div id="record-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm space-y-6">
            <h3 class="text-2xl font-bold text-gray-800 text-center">è©¦åˆçµæœã‚’è¨˜éŒ²</h3>
            
            <div class="space-y-3">
                <label for="opponent-deck-input" class="block text-sm font-medium text-gray-700">å¯¾æˆ¦ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­å</label>
                <input type="text" id="opponent-deck-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹: é’é»’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«">
                <div id="opponent-deck-error" class="text-red-500 text-sm hidden">ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­åã¯å¿…é ˆã§ã™ã€‚</div>
            </div>

            <!-- ã‚³ã‚¤ãƒ³ãƒˆã‚¹çµæœã®é¸æŠ -->
            <div class="space-y-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="block text-sm font-medium text-gray-700">1. ğŸª™ ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã®çµæœ</p>
                <div class="flex space-x-4 justify-center">
                    <label class="inline-flex items-center">
                        <input type="radio" name="coin-result" value="win" class="form-radio text-green-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-800 font-medium">å‹åˆ© (Win)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="coin-result" value="loss" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-2 text-gray-800 font-medium">æ•—åŒ— (Loss)</span>
                    </label>
                </div>
            </div>

            <!-- é¸æŠã—ãŸè¡Œå‹• (å…ˆè¡Œ/å¾Œæ”») ã®é¸æŠ -->
            <div class="space-y-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                <p class="block text-sm font-medium text-gray-700">2. âš”ï¸ é¸æŠã—ãŸè¡Œå‹• (å…ˆè¡Œ/å¾Œæ”»)</p>
                <div class="flex space-x-4 justify-center">
                    <label class="inline-flex items-center">
                        <input type="radio" name="starting-player" value="first" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-800 font-medium">å…ˆè¡Œ (1st)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="starting-player" value="second" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-2 text-gray-800 font-medium">å¾Œæ”» (2nd)</span>
                    </label>
                </div>
                <div id="starting-player-error" class="text-red-500 text-sm hidden text-center">å…ˆè¡Œ/å¾Œæ”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </div>
            
            <div class="flex space-x-4">
                <button id="record-win-btn" class="w-1/2 py-3 text-white text-lg font-bold rounded-xl bg-green-500 hover:bg-green-600 disabled:opacity-50">
                    <span class="text-xl mr-1">ğŸ†</span> å‹åˆ©
                </button>
                <button id="record-loss-btn" class="w-1/2 py-3 text-white text-lg font-bold rounded-xl bg-red-500 hover:bg-red-600 disabled:opacity-50">
                    <span class="text-xl mr-1">ğŸ˜</span> æ•—åŒ—
                </button>
            </div>

            <div class="text-right">
                <button id="record-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« (MODAL 3: ãƒªã‚»ãƒƒãƒˆç”¨) -->
    <div id="confirm-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm space-y-4">
            <p class="text-lg font-semibold text-gray-800" id="confirm-modal-message">æœ¬å½“ã«ã“ã®ãƒ‡ãƒƒã‚­ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-ok-btn" class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« (MODAL 4) -->
    <div id="charts-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl h-5/6 flex flex-col space-y-4">
            <h3 class="text-2xl font-bold text-gray-800 text-center border-b pb-2" id="charts-modal-title">ğŸ“ˆ ãƒ‡ãƒƒã‚­åˆ†æã‚°ãƒ©ãƒ•</h3>
            
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex justify-center border-b border-gray-200">
                <button data-chart="win-loss" class="chart-tab px-4 py-2 text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition-colors">
                    å‹æ•—å†…è¨³
                </button>
                <button data-chart="matchup" class="chart-tab px-4 py-2 text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition-colors">
                    ãƒãƒƒãƒã‚¢ãƒƒãƒ—å‹ç‡
                </button>
                <button data-chart="trend" class="chart-tab px-4 py-2 text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition-colors tab-active">
                    å‹ç‡å¤‰å‹• (æ™‚ç³»åˆ—)
                </button>
            </div>

            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="flex-grow overflow-auto p-2">
                <!-- å‹æ•—å†…è¨³ (ãƒ‰ãƒ¼ãƒŠãƒ„) -->
                <div id="chart-win-loss" class="chart-container" style="display:none;">
                    <canvas id="winLossChart"></canvas>
                </div>
                <!-- ãƒãƒƒãƒã‚¢ãƒƒãƒ—å‹ç‡ (æ£’ã‚°ãƒ©ãƒ•) -->
                <div id="chart-matchup" class="chart-container" style="display:none;">
                    <canvas id="matchupBarChart"></canvas>
                </div>
                <!-- å‹ç‡å¤‰å‹• (æŠ˜ã‚Œç·š) -->
                <div id="chart-trend" class="chart-container" style="display:flex;">
                    <canvas id="winRateTrendChart"></canvas>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div id="chart-no-data" class="h-full flex items-center justify-center text-gray-500 text-center" style="display:none;">
                    <p class="text-xl">ğŸ“Š è©¦åˆè¨˜éŒ²ãŒãªã„ãŸã‚ã€ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

            <div class="text-right border-t pt-4">
                <button id="charts-modal-close-btn" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>


    <!-- Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            addDoc, 
            setLogLevel, 
            getDocs,
            deleteDoc,
            writeBatch,
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
        setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
        let app;
        let db;
        let auth;
        let userId = null;
        let unsubscribeDecks = null; // ãƒ‡ãƒƒã‚­ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç”¨
        let unsubscribeMatches = null; // è©¦åˆçµæœãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // Chart.js ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä¿æŒ
        let winLossChartInstance = null;
        let matchupBarChartInstance = null;
        let winRateTrendChartInstance = null; 
        let currentChartType = 'trend'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ 'trend' (å‹ç‡å¤‰å‹•) ã«è¨­å®š

        // DOMè¦ç´ ã®å–å¾—
        const deckSelect = document.getElementById('deck-select');
        const addDeckBtn = document.getElementById('add-deck-btn');
        const currentDeckNameDisplay = document.getElementById('current-deck-name');
        const winsDisplay = document.getElementById('wins-display');
        const lossesDisplay = document.getElementById('losses-display');
        const totalGamesDisplay = document.getElementById('total-games-display');
        const winRateDisplay = document.getElementById('win-rate-display');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const openRecordModalBtn = document.getElementById('open-record-modal-btn');
        const openChartsModalBtn = document.getElementById('open-charts-modal-btn'); 
        const resetBtn = document.getElementById('reset-btn');
        const statsArea = document.getElementById('stats-area');
        const opponentStatsList = document.getElementById('opponent-stats-list'); 
        const appMessage = document.getElementById('app-message');

        // å…ˆè¡Œ/å¾Œæ”»é–¢é€£ã®DOMè¦ç´ 
        const firstSecondStatsArea = document.getElementById('first-second-stats');
        const firstWinRateDisplay = document.getElementById('first-win-rate-display');
        const firstWLDisplay = document.getElementById('first-wl-display');
        const secondWinRateDisplay = document.getElementById('second-win-rate-display');
        const secondWLDisplay = document.getElementById('second-wl-display');
        
        // ã‚³ã‚¤ãƒ³ãƒˆã‚¹é–¢é€£ã®DOMè¦ç´ 
        const coinStatsArea = document.getElementById('coin-stats-area');
        const coinWinRateDisplay = document.getElementById('coin-win-rate-display');
        const coinWinWLDisplay = document.getElementById('coin-win-wl-display');
        const coinLossRateDisplay = document.getElementById('coin-loss-rate-display');
        const coinLossWLDisplay = document.getElementById('coin-loss-wl-display');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆé–¢é€£ã®DOMè¦ç´ 
        const globalWlDisplay = document.getElementById('global-wl-display');
        const globalTotalDisplay = document.getElementById('global-total-display');
        const globalWinRateDisplay = document.getElementById('global-win-rate-display');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const deckModal = document.getElementById('deck-modal');
        const newDeckNameInput = document.getElementById('new-deck-name-input');
        const deckModalAddBtn = document.getElementById('deck-modal-add-btn');
        const deckModalCancelBtn = document.getElementById('deck-modal-cancel-btn');
        const deckNameError = document.getElementById('deck-name-error');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const recordModal = document.getElementById('record-modal');
        const opponentDeckInput = document.getElementById('opponent-deck-input');
        const opponentDeckError = document.getElementById('opponent-deck-error');
        const recordWinBtn = document.getElementById('record-win-btn');
        const recordLossBtn = document.getElementById('record-loss-btn');
        const recordModalCancelBtn = document.getElementById('record-modal-cancel-btn');
        
        // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚³ã‚¤ãƒ³ãƒˆã‚¹è¦ç´ 
        const coinResultInputs = document.querySelectorAll('input[name="coin-result"]'); 
        const startingPlayerInputs = document.querySelectorAll('input[name="starting-player"]');

        // ã‚°ãƒ©ãƒ•é–¢é€£ã®DOMè¦ç´ 
        const chartsModal = document.getElementById('charts-modal');
        const chartsModalTitle = document.getElementById('charts-modal-title');
        const chartTabs = document.querySelectorAll('.chart-tab');
        const chartContainers = {
            'win-loss': document.getElementById('chart-win-loss'),
            'matchup': document.getElementById('chart-matchup'),
            'trend': document.getElementById('chart-trend')
        };
        const chartNoData = document.getElementById('chart-no-data');


        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        let decks = []; 
        let selectedDeckId = null;
        let selectedDeckMatches = []; 
        let allMatches = []; // â˜…è¿½åŠ : å…¨ãƒ‡ãƒƒã‚­ã®è©¦åˆçµæœã‚’ãƒ•ãƒ©ãƒƒãƒˆã«æ ¼ç´ã™ã‚‹é…åˆ— (ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆç”¨)
        let currentDeckStats = { 
            wins: 0, 
            losses: 0, 
            total: 0, 
            opponentStats: {},
            firstStats: { wins: 0, losses: 0 },
            secondStats: { wins: 0, losses: 0 },
            coinStats: { 
                win: { wins: 0, losses: 0 },
                loss: { wins: 0, losses: 0 }
            }
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ±ç”¨é–¢æ•°
         */
        function toggleModal(modalElement, isVisible) {
            modalElement.classList.toggle('hidden', !isVisible);
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºã™ã‚‹
         */
        function showMessage(msg, type = 'info') {
            appMessage.textContent = msg;
            appMessage.style.display = 'block';
            appMessage.className = `p-3 rounded-lg text-sm mb-4 transition-all duration-300`;

            switch (type) {
                case 'success':
                    appMessage.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    break;
                case 'error':
                    appMessage.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                    break;
                case 'warning':
                    appMessage.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
                    break;
                case 'info':
                default:
                    appMessage.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
                    break;
            }

            // 4ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            clearTimeout(window.messageTimeout);
            window.messageTimeout = setTimeout(() => {
                appMessage.style.display = 'none';
                appMessage.textContent = '';
                appMessage.className = 'p-3 rounded-lg text-sm mb-4 transition-all duration-300';
            }, 4000);
        }

        /**
         * ãƒ‡ãƒƒã‚­ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’å–å¾—
         */
        function getDeckCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, 'artifacts', appId, 'users', userId, 'decks');
        }
        
        /**
         * é¸æŠä¸­ã®ãƒ‡ãƒƒã‚­ã®è©¦åˆçµæœã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’å–å¾—
         */
        function getMatchResultsCollectionRef(deckId = selectedDeckId) {
            if (!db || !userId || !deckId) return null;
            const deckDocRef = doc(db, 'artifacts', appId, 'users', userId, 'decks', deckId);
            return collection(deckDocRef, 'match_results');
        }

        /**
         * æ–°ã—ã„ãƒ‡ãƒƒã‚­ã‚’Firestoreã«è¿½åŠ 
         */
        async function addDeck(name) {
            const colRef = getDeckCollectionRef();
            if (!colRef) {
                throw new Error("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚");
            }

            // addDocãŒæˆåŠŸã™ã‚Œã°ã€onSnapshotãŒç™ºç«ã—ã€UIãŒæ›´æ–°ã•ã‚Œã‚‹
            await addDoc(colRef, {
                name: name,
                createdAt: serverTimestamp(),
            });
            console.log("ãƒ‡ãƒƒã‚­è¿½åŠ æˆåŠŸ:", name);
        }

        /**
         * â˜…è¿½åŠ : å…¨ã¦ã®ãƒ‡ãƒƒã‚­ã®è©¦åˆçµæœã‚’Firestoreã‹ã‚‰éåŒæœŸã§å–å¾—ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’æ›´æ–°
         */
        async function fetchAllMatchesForGlobalStats(decksList) {
            if (!db || !userId) {
                renderGlobalStats(); // èªè¨¼/ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
                return;
            }

            allMatches = []; // å…¨ä½“ã®è©¦åˆçµæœã‚’ãƒªã‚»ãƒƒãƒˆ
            const fetchPromises = [];

            for (const deck of decksList) {
                const colRef = getMatchResultsCollectionRef(deck.id);
                if (colRef) {
                    // getDocsã‚’ä½¿ç”¨ã—ã¦è©¦åˆçµæœã‚’éåŒæœŸã§å–å¾—
                    fetchPromises.push(getDocs(colRef).then(snapshot => {
                        const deckMatches = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.timestamp && data.timestamp.toDate) {
                                data.timestamp = data.timestamp.toDate();
                            }
                            // ã©ã®ãƒ‡ãƒƒã‚­ã®çµæœã‹ã‚ã‹ã‚‹ã‚ˆã†ã«deckIdã‚’ä»˜ä¸
                            deckMatches.push({ id: doc.id, deckId: deck.id, ...data });
                        });
                        return deckMatches;
                    }));
                }
            }

            try {
                const results = await Promise.all(fetchPromises);
                results.forEach(deckMatches => {
                    allMatches.push(...deckMatches); // å…¨è©¦åˆçµæœã‚’çµåˆ
                });
                
                // å…¨è©¦åˆçµæœã‚’å–å¾—å¾Œã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                renderGlobalStats();

            } catch (error) {
                console.error("ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆç”¨è©¦åˆçµæœã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("å…¨ãƒ‡ãƒƒã‚­ã®çµ±è¨ˆãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'error');
            }
        }
        
        /**
         * ãƒ‡ãƒƒã‚­ä¸€è¦§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
         */
        function setupDeckListener() {
            if (unsubscribeDecks) unsubscribeDecks(); 
            
            const colRef = getDeckCollectionRef();
            if (!colRef) return;

            const q = query(colRef, orderBy('createdAt', 'desc')); 

            unsubscribeDecks = onSnapshot(q, async (snapshot) => {
                decks = [];
                snapshot.forEach(doc => {
                    decks.push({ id: doc.id, ...doc.data() });
                });
                
                // é¸æŠä¸­ã®ãƒ‡ãƒƒã‚­IDãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                const currentDeckExists = decks.some(d => d.id === selectedDeckId);

                // ã‚‚ã—é¸æŠä¸­ã®IDãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ã¾ã ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
                if (!currentDeckExists && decks.length > 0) {
                    selectedDeckId = decks[0].id;
                } else if (decks.length === 0) {
                    selectedDeckId = null;
                }

                // â˜…ä¿®æ­£ç‚¹: ãƒ‡ãƒƒã‚­ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’æ›´æ–°
                await fetchAllMatchesForGlobalStats(decks); 
                
                // ãƒãƒƒãƒçµæœãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®šï¼ˆé¸æŠãƒ‡ãƒƒã‚­ãŒå¤‰ã‚ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
                setupMatchResultsListener(); 
                renderApp();
            }, (error) => {
                console.error("ãƒ‡ãƒƒã‚­ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("ãƒ‡ãƒƒã‚­ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'error');
            });
        }

        /**
         * é¸æŠä¸­ã®ãƒ‡ãƒƒã‚­ã®è©¦åˆçµæœãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
         */
        function setupMatchResultsListener() {
            if (unsubscribeMatches) unsubscribeMatches(); // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤

            const colRef = getMatchResultsCollectionRef();
            if (!colRef || !selectedDeckId) {
                selectedDeckMatches = [];
                renderApp();
                return;
            }

            // æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ã®ãŸã‚ã«timestampã§æ˜‡é †ã‚½ãƒ¼ãƒˆã™ã‚‹
            const q = query(colRef, orderBy('timestamp', 'asc'));

            unsubscribeMatches = onSnapshot(q, (snapshot) => {
                selectedDeckMatches = [];
                snapshot.forEach(doc => {
                    // Firebase Timestampã‚’JavaScript Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate();
                    }
                    selectedDeckMatches.push({ id: doc.id, ...data });
                });
                
                // â˜…ä¿®æ­£ç‚¹: å˜ä¸€ãƒ‡ãƒƒã‚­ã®è©¦åˆçµæœãŒå¤‰ã‚ã£ãŸå ´åˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’å†å–å¾—ãƒ»æ›´æ–°
                fetchAllMatchesForGlobalStats(decks);
                
                renderApp();
            }, (error) => {
                console.error("è©¦åˆçµæœã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            });
        }

        // --- Chart.js ã‚°ãƒ©ãƒ•æç”»é–¢é€£ã®é–¢æ•° (å¤‰æ›´ãªã—) ---

        /**
         * æ—¢å­˜ã®Chart.jsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã™ã¹ã¦ç ´æ£„ã™ã‚‹
         */
        function destroyChartInstances() {
            if (winLossChartInstance) {
                winLossChartInstance.destroy();
                winLossChartInstance = null;
            }
            if (matchupBarChartInstance) {
                matchupBarChartInstance.destroy();
                matchupBarChartInstance = null;
            }
            if (winRateTrendChartInstance) {
                winRateTrendChartInstance.destroy();
                winRateTrendChartInstance = null;
            }
        }

        /**
         * å‹åˆ©/æ•—åŒ—ã®å†…è¨³ã‚°ãƒ©ãƒ• (ãƒ‰ãƒ¼ãƒŠãƒ„ãƒãƒ£ãƒ¼ãƒˆ) ã‚’æç”»
         */
        function renderWinLossChart() {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            const data = {
                labels: ['å‹åˆ© (W)', 'æ•—åŒ— (L)'],
                datasets: [{
                    label: 'å‹æ•—æ•°',
                    data: [currentDeckStats.wins, currentDeckStats.losses],
                    backgroundColor: [
                        'rgb(16, 185, 129)', // Tailwind green-500
                        'rgb(239, 68, 68)'   // Tailwind red-500
                    ],
                    hoverOffset: 8
                }]
            };

            destroyChartInstances();

            winLossChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'å‹åˆ© vs æ•—åŒ— ã®å†…è¨³',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }

        /**
         * å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã‚°ãƒ©ãƒ• (æ£’ã‚°ãƒ©ãƒ•) ã‚’æç”»
         */
        function renderMatchupBarChart() {
            const ctx = document.getElementById('matchupBarChart').getContext('2d');
            
            const opponentData = Object.entries(currentDeckStats.opponentStats)
                .map(([name, stats]) => ({
                    name,
                    total: stats.wins + stats.losses,
                    rate: stats.wins + stats.losses > 0 ? (stats.wins / (stats.wins + stats.losses)) : 0,
                    wins: stats.wins,
                    losses: stats.losses
                }))
                .filter(d => d.total > 0)
                .sort((a, b) => b.rate - a.rate); // å‹ç‡ã§é™é †ã‚½ãƒ¼ãƒˆ

            const labels = opponentData.map(d => d.name);
            const rates = opponentData.map(d => (d.rate * 100).toFixed(1));
            const tooltips = opponentData.map(d => `${d.wins}W / ${d.losses}L`);
            
            destroyChartInstances();

            matchupBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‹ç‡ (%)',
                        data: rates,
                        backgroundColor: opponentData.map(d => d.rate >= 0.5 ? 'rgb(59, 130, 246)' : 'rgb(249, 115, 22)'),
                        borderColor: opponentData.map(d => d.rate >= 0.5 ? 'rgb(30, 64, 175)' : 'rgb(194, 65, 12)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // æ¨ªå‘ãã®æ£’ã‚°ãƒ©ãƒ•
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ (è©¦åˆæ•°é †)',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return `${context.dataset.label}: ${context.parsed.x}% (${tooltips[index]})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            max: 100,
                            title: {
                                display: true,
                                text: 'å‹ç‡ (%)'
                            }
                        }
                    }
                }
            });
        }

        /**
         * å‹ç‡å¤‰å‹•ã‚°ãƒ©ãƒ• (æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•) ã‚’æç”»
         */
        function renderWinRateTrendChart() {
            const ctx = document.getElementById('winRateTrendChart').getContext('2d');
            
            // è©¦åˆã‚’æ™‚åˆ»é †ï¼ˆtimestampï¼‰ã«å‡¦ç†
            const sortedMatches = selectedDeckMatches; 
            if (sortedMatches.length === 0) return;

            let cumulativeWins = 0;
            let cumulativeTotal = 0;
            const trendData = [];
            const labels = [];

            sortedMatches.forEach((match, index) => {
                cumulativeTotal += 1;
                if (match.result === 'win') {
                    cumulativeWins += 1;
                }
                const winRate = (cumulativeWins / cumulativeTotal) * 100;
                
                trendData.push(winRate.toFixed(2));
                
                // ãƒ©ãƒ™ãƒ«ã¯é€£ç•ªã€ã¾ãŸã¯æ—¥ä»˜ã¨æ™‚åˆ»ï¼ˆFireStore TimestampãŒDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹å‰æï¼‰
                const matchDate = match.timestamp instanceof Date ? match.timestamp : new Date();
                labels.push(`${index + 1}è©¦åˆç›® (${matchDate.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' })})`);
            });

            destroyChartInstances();

            winRateTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç´¯ç©å‹ç‡ (%)',
                        data: trendData,
                        borderColor: 'rgb(234, 88, 12)', // Tailwind orange-600
                        backgroundColor: 'rgba(234, 88, 12, 0.1)',
                        tension: 0.3,
                        pointRadius: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: {
                            display: true,
                            text: 'ç´¯ç©å‹ç‡ã®å¤‰å‹• (æ™‚ç³»åˆ—)',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `ç´¯ç©å‹ç‡: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'å‹ç‡ (%)' }
                        },
                        x: {
                            title: { display: true, text: 'è©¦åˆé †' }
                        }
                    }
                }
            });
        }


        /**
         * æŒ‡å®šã•ã‚ŒãŸã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’è¡¨ç¤ºã—ã€æç”»é–¢æ•°ã‚’å‘¼ã³å‡ºã™
         */
        function showChart(chartType) {
            currentChartType = chartType;
            const totalGames = currentDeckStats.total;

            // 1. ã™ã¹ã¦ã®ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤ºã«ã—ã€ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ
            Object.values(chartContainers).forEach(container => container.style.display = 'none');
            chartNoData.style.display = 'none';
            chartTabs.forEach(t => t.classList.remove('tab-active'));
            document.querySelector(`.chart-tab[data-chart="${chartType}"]`).classList.add('tab-active');
            
            // 2. ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (totalGames === 0) {
                destroyChartInstances();
                chartNoData.style.display = 'flex';
                return;
            }
            
            // 3. è©²å½“ã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã€æç”»é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            const container = chartContainers[chartType];
            container.style.display = 'flex'; // Chart.jsã®æç”»ã«ã¯ã‚³ãƒ³ãƒ†ãƒŠãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹

            switch (chartType) {
                case 'win-loss':
                    renderWinLossChart();
                    break;
                case 'matchup':
                    renderMatchupBarChart();
                    break;
                case 'trend':
                    renderWinRateTrendChart();
                    break;
            }
        }
        
        // --- çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆé–¢æ•° (å¤‰æ›´ãªã—) ---
        
        /**
         * çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆã‚’è¡Œã†
         */
        function calculateStats(matches) {
            return matches.reduce((acc, match) => {
                const opponent = match.opponentDeck || 'ä¸æ˜ãªãƒ‡ãƒƒã‚­';
                if (!acc.opponentStats[opponent]) {
                    acc.opponentStats[opponent] = { wins: 0, losses: 0 };
                }

                const startingPlayer = match.startingPlayer || 'unknown';
                const coinResult = match.coinResult || 'unknown'; 

                const isWin = match.result === 'win';
                const isLoss = match.result === 'loss';

                if (isWin) {
                    acc.wins += 1;
                    acc.opponentStats[opponent].wins += 1;
                    if (startingPlayer === 'first') acc.firstStats.wins += 1; 
                    if (startingPlayer === 'second') acc.secondStats.wins += 1; 
                    if (coinResult === 'win') acc.coinStats.win.wins += 1;
                    if (coinResult === 'loss') acc.coinStats.loss.wins += 1;
                } else if (isLoss) {
                    acc.losses += 1;
                    acc.opponentStats[opponent].losses += 1;
                    if (startingPlayer === 'first') acc.firstStats.losses += 1; 
                    if (startingPlayer === 'second') acc.secondStats.losses += 1; 
                    if (coinResult === 'win') acc.coinStats.win.losses += 1;
                    if (coinResult === 'loss') acc.coinStats.loss.losses += 1;
                }
                acc.total = acc.wins + acc.losses;
                return acc;
            }, { 
                wins: 0, 
                losses: 0, 
                total: 0, 
                opponentStats: {},
                firstStats: { wins: 0, losses: 0 }, 
                secondStats: { wins: 0, losses: 0 },
                coinStats: { 
                    win: { wins: 0, losses: 0 },
                    loss: { wins: 0, losses: 0 }
                } 
            });
        }
        
        /**
         * â˜…è¿½åŠ : å…¨ã¦ã®è©¦åˆçµæœ (allMatches) ã‚’ä½¿ç”¨ã—ã¦ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderGlobalStats() {
            const globalStats = calculateStats(allMatches);
            const { wins, losses, total } = globalStats;
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(2) : '0.00';

            globalWlDisplay.textContent = `${wins}/${losses}`;
            globalTotalDisplay.textContent = total;
            globalWinRateDisplay.textContent = `${winRate}%`;
        }


        /**
         * çŠ¶æ…‹ã«åŸºã¥ã„ã¦UIå…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (é¸æŠä¸­ãƒ‡ãƒƒã‚­ã®çµ±è¨ˆã®ã¿ã‚’å‡¦ç†)
         */
        function renderApp() {
            currentDeckStats = calculateStats(selectedDeckMatches);
            const { wins, losses, total, opponentStats, firstStats, secondStats, coinStats } = currentDeckStats;
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(2) : '0.00';

            // å…ˆè¡Œ/å¾Œæ”»ã®å‹ç‡è¨ˆç®—
            const firstTotal = firstStats.wins + firstStats.losses;
            const firstWinRate = firstTotal > 0 ? ((firstStats.wins / firstTotal) * 100).toFixed(2) : '0.00';
            const secondTotal = secondStats.wins + secondStats.losses;
            const secondWinRate = secondTotal > 0 ? ((secondStats.wins / secondTotal) * 100).toFixed(2) : '0.00';
            
            // ã‚³ã‚¤ãƒ³ãƒˆã‚¹å‹æ•—åˆ¥ã®å‹ç‡è¨ˆç®—
            const coinWinTotal = coinStats.win.wins + coinStats.win.losses;
            const coinWinRate = coinWinTotal > 0 ? ((coinStats.win.wins / coinWinTotal) * 100).toFixed(2) : '0.00';
            const coinLossTotal = coinStats.loss.wins + coinStats.loss.losses;
            const coinLossRate = coinLossTotal > 0 ? ((coinStats.loss.wins / coinLossTotal) * 100).toFixed(2) : '0.00';


            // 1. ãƒ‡ãƒƒã‚­é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
            deckSelect.innerHTML = '<option value="">ãƒ‡ãƒƒã‚­ã‚’é¸æŠã¾ãŸã¯è¿½åŠ ã—ã¦ãã ã•ã„</option>';
            decks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = deck.name;
                deckSelect.appendChild(option);
            });
            deckSelect.value = selectedDeckId || "";


            const selectedDeck = decks.find(d => d.id === selectedDeckId);

            if (selectedDeck) {
                statsArea.classList.remove('opacity-50', 'pointer-events-none');
                firstSecondStatsArea.classList.remove('opacity-50', 'pointer-events-none'); 
                coinStatsArea.classList.remove('opacity-50', 'pointer-events-none'); 
                
                currentDeckNameDisplay.textContent = selectedDeck.name;
                winsDisplay.textContent = wins;
                lossesDisplay.textContent = losses;
                totalGamesDisplay.textContent = total;
                winRateDisplay.textContent = `${winRate}%`;

                // å…ˆè¡Œ/å¾Œæ”»ã®UIæ›´æ–°
                firstWinRateDisplay.textContent = `${firstWinRate}%`;
                firstWLDisplay.textContent = `${firstStats.wins}W / ${firstStats.losses}L`;
                secondWinRateDisplay.textContent = `${secondWinRate}%`;
                secondWLDisplay.textContent = `${secondStats.wins}W / ${secondStats.losses}L`;

                // ã‚³ã‚¤ãƒ³ãƒˆã‚¹çµæœã®UIæ›´æ–°
                coinWinRateDisplay.textContent = `${coinWinRate}%`;
                coinWinWLDisplay.textContent = `${coinStats.win.wins}W / ${coinStats.win.losses}L`;
                coinLossRateDisplay.textContent = `${coinLossRate}%`;
                coinLossWLDisplay.textContent = `${coinStats.loss.wins}W / ${coinStats.loss.losses}L`;


                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
                openRecordModalBtn.disabled = false;
                openChartsModalBtn.disabled = (total === 0); 
                resetBtn.disabled = (total === 0);

            } else {
                statsArea.classList.add('opacity-50', 'pointer-events-none');
                firstSecondStatsArea.classList.add('opacity-50', 'pointer-events-none'); 
                coinStatsArea.classList.add('opacity-50', 'pointer-events-none'); 

                currentDeckNameDisplay.textContent = "ãƒ‡ãƒƒã‚­ã‚’é¸æŠã—ã¦ãã ã•ã„";
                winsDisplay.textContent = '0';
                lossesDisplay.textContent = '0';
                totalGamesDisplay.textContent = '0';
                winRateDisplay.textContent = '0.00%';

                // å…ˆè¡Œ/å¾Œæ”»ã®UIãƒªã‚»ãƒƒãƒˆ
                firstWinRateDisplay.textContent = '0.00%';
                firstWLDisplay.textContent = '0W / 0L';
                secondWinRateDisplay.textContent = '0.00%';
                secondWLDisplay.textContent = '0W / 0L';

                // ã‚³ã‚¤ãƒ³ãƒˆã‚¹çµæœã®UIãƒªã‚»ãƒƒãƒˆ
                coinWinRateDisplay.textContent = '0.00%';
                coinWinWLDisplay.textContent = '0W / 0L';
                coinLossRateDisplay.textContent = '0.00%';
                coinLossWLDisplay.textContent = '0W / 0L';

                // ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–
                openRecordModalBtn.disabled = true;
                openChartsModalBtn.disabled = true;
                resetBtn.disabled = true;
            }

            // 2. å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã®ãƒªã‚¹ãƒˆè¡¨ç¤º
            opponentStatsList.innerHTML = '';
            const opponentNames = Object.keys(opponentStats).sort();

            if (opponentNames.length === 0) {
                opponentStatsList.innerHTML = '<p class="text-center text-gray-500 text-sm">è¨˜éŒ²ã•ã‚ŒãŸè©¦åˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                opponentNames.forEach(name => {
                    const stats = opponentStats[name];
                    const totalOpponentGames = stats.wins + stats.losses;
                    const opponentWinRate = totalOpponentGames > 0 ? ((stats.wins / totalOpponentGames) * 100).toFixed(1) : '0.0';

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-white rounded-lg border border-purple-100';
                    const rateColor = parseFloat(opponentWinRate) >= 50 ? 'text-green-600' : 'text-red-600';
                    item.innerHTML = `
                        <span class="text-sm font-semibold text-gray-700 truncate">${name}</span>
                        <div class="text-right flex items-center space-x-2">
                            <span class="text-xs text-gray-500">${stats.wins}W/${stats.losses}L</span>
                            <span class="text-lg font-bold ${rateColor}">${opponentWinRate}%</span>
                        </div>
                    `;
                    opponentStatsList.appendChild(item);
                });
            }
        }

        /**
         * è©¦åˆçµæœã‚’Firestoreã«è¨˜éŒ²
         */
        async function recordMatchResult(result, opponentDeck, startingPlayer, coinResult) {
            const colRef = getMatchResultsCollectionRef();
            if (!colRef) {
                showMessage("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒƒã‚­ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", 'error');
                return;
            }

            try {
                const matchResult = {
                    result: result,
                    opponentDeck: opponentDeck.trim(),
                    timestamp: serverTimestamp(), // ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
                    startingPlayer: startingPlayer,
                    coinResult: coinResult 
                };
                await addDoc(colRef, matchResult);
                showMessage("è©¦åˆçµæœã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚", 'success');
            } catch (error) {
                console.error("è©¦åˆçµæœã®è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                showMessage("è©¦åˆçµæœã®è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        /**
         * å…¨ã¦ã®è©¦åˆçµæœã‚’å‰Šé™¤
         */
        async function deleteAllMatchResults() {
            const colRef = getMatchResultsCollectionRef();
            if (!colRef) return;

            try {
                // orderBy('timestamp', 'asc') ã‚’å‰Šé™¤ã—ã€ç°¡æ˜“çš„ãªã‚¯ã‚¨ãƒªã«ã™ã‚‹ï¼ˆãƒãƒƒãƒå‡¦ç†ã®ãŸã‚ï¼‰
                const snapshot = await getDocs(colRef);
                const batch = writeBatch(db);

                if (snapshot.empty) {
                    showMessage("å‰Šé™¤å¯¾è±¡ã®è©¦åˆè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 'info');
                    return;
                }

                snapshot.docs.forEach((d) => {
                    batch.delete(d.ref);
                });

                await batch.commit();
                showMessage(`ãƒ‡ãƒƒã‚­ã®è©¦åˆè¨˜éŒ²ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`, 'success');
            } catch (error) {
                console.error("è©¦åˆè¨˜éŒ²ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                showMessage("è©¦åˆè¨˜éŒ²ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        /**
         * ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
         */
        function showConfirmModal(message) {
            document.getElementById('confirm-modal-message').textContent = message;
            toggleModal(confirmModal, true);
            return new Promise((resolve) => {
                const handleOk = () => {
                    toggleModal(confirmModal, false);
                    confirmOkBtn.removeEventListener('click', handleOk);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                const handleCancel = () => {
                    toggleModal(confirmModal, false);
                    confirmOkBtn.removeEventListener('click', handleOk);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                confirmOkBtn.addEventListener('click', handleOk);
                confirmCancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        /**
         * FirebaseåˆæœŸåŒ–ã¨èªè¨¼
         */
        async function initFirebaseAndAuth() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    authStatus.textContent = "Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚";
                    console.error("Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authStatus.textContent = "èªè¨¼æ¸ˆã¿ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...";
                        deckSelect.disabled = false;
                        addDeckBtn.disabled = false;
                        setupDeckListener(); // èªè¨¼å¾Œã€ãƒ‡ãƒƒã‚­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
                    } else {
                        userId = null;
                        userIdDisplay.textContent = "æœªèªè¨¼";
                        authStatus.textContent = "æœªèªè¨¼ã€‚åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è©¦ã¿ã¾ã™...";
                        deckSelect.disabled = true;
                        addDeckBtn.disabled = true;
                        openRecordModalBtn.disabled = true;
                        openChartsModalBtn.disabled = true;
                        resetBtn.disabled = true;
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                authStatus.textContent = "èªè¨¼ã‚¨ãƒ©ãƒ¼: " + error.message;
                showMessage(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

        // ãƒ‡ãƒƒã‚­é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´
        deckSelect.addEventListener('change', (e) => {
            selectedDeckId = e.target.value;
            setupMatchResultsListener();
            renderApp();
        });

        // è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        openRecordModalBtn.addEventListener('click', () => {
            opponentDeckInput.value = ''; 
            opponentDeckError.classList.add('hidden'); 
            coinResultInputs[0].checked = true;       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã€Œå‹åˆ©ã€
            startingPlayerInputs[0].checked = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œå…ˆè¡Œã€
            toggleModal(recordModal, true);
            opponentDeckInput.focus();
        });

        // è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        recordModalCancelBtn.addEventListener('click', () => {
            toggleModal(recordModal, false);
        });
        
        // è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå¯¾æˆ¦ç›¸æ‰‹ãƒ‡ãƒƒã‚­åå…¥åŠ›æ¤œè¨¼
        opponentDeckInput.addEventListener('input', () => {
            const name = opponentDeckInput.value.trim();
            const disabled = name.length === 0;
            recordWinBtn.disabled = disabled;
            recordLossBtn.disabled = disabled;
            if (disabled) {
                opponentDeckError.classList.remove('hidden');
            } else {
                opponentDeckError.classList.add('hidden');
            }
        });

        /** è©¦åˆè¨˜éŒ²ãƒœã‚¿ãƒ³ã®å…±é€šãƒãƒ³ãƒ‰ãƒ© */
        const handleRecordClick = async (result) => {
            const opponentName = opponentDeckInput.value.trim();
            const selectedStartingPlayer = document.querySelector('input[name="starting-player"]:checked');
            const selectedCoinResult = document.querySelector('input[name="coin-result"]:checked'); 
            
            if (opponentName.length === 0) {
                opponentDeckError.classList.remove('hidden');
                return;
            }
            
            if (!selectedStartingPlayer || !selectedCoinResult) {
                console.error("å¿…é ˆé …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            
            await recordMatchResult(result, opponentName, selectedStartingPlayer.value, selectedCoinResult.value);
            toggleModal(recordModal, false);
        };

        // è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå‹åˆ©ã‚’è¨˜éŒ²
        recordWinBtn.addEventListener('click', () => handleRecordClick('win'));
        
        // è©¦åˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ•—åŒ—ã‚’è¨˜éŒ²
        recordLossBtn.addEventListener('click', () => handleRecordClick('loss'));


        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        resetBtn.addEventListener('click', async () => {
            const deckName = decks.find(d => d.id === selectedDeckId)?.name || 'ã“ã®ãƒ‡ãƒƒã‚­';
            const confirmed = await showConfirmModal(`ãƒ‡ãƒƒã‚­ã€Œ${deckName}ã€ã®**å…¨ã¦ã®è©¦åˆè¨˜éŒ²**ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ`);
            
            if (confirmed) {
                await deleteAllMatchResults(); 
            }
        });

        // ãƒ‡ãƒƒã‚­è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
        addDeckBtn.addEventListener('click', () => {
            newDeckNameInput.value = ''; 
            deckModalAddBtn.disabled = true; 
            deckNameError.classList.add('hidden'); 
            toggleModal(deckModal, true);
            newDeckNameInput.focus();
        });

        // ãƒ‡ãƒƒã‚­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        deckModalCancelBtn.addEventListener('click', () => {
            toggleModal(deckModal, false);
        });

        // ãƒ‡ãƒƒã‚­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå…¥åŠ›å€¤æ¤œè¨¼
        newDeckNameInput.addEventListener('input', () => {
            const name = newDeckNameInput.value.trim();
            if (name.length > 0) {
                deckModalAddBtn.disabled = false;
                deckNameError.classList.add('hidden');
            } else {
                deckModalAddBtn.disabled = true;
            }
        });
        
        // ãƒ‡ãƒƒã‚­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¿½åŠ å®Ÿè¡Œ (ä¿®æ­£ãƒ»å¼·åŒ–æ¸ˆã¿ãƒ­ã‚¸ãƒƒã‚¯)
        deckModalAddBtn.addEventListener('click', async () => {
            const deckName = newDeckNameInput.value.trim();
            if (!deckName) {
                deckNameError.classList.remove('hidden');
                return;
            }
            
            if (!userId) {
                showMessage('ã‚¨ãƒ©ãƒ¼: èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            // UIã‚’ç„¡åŠ¹åŒ–ã—ã¦å¾…æ©ŸçŠ¶æ…‹ã‚’ç¤ºã™
            deckModalAddBtn.disabled = true;
            deckModalAddBtn.textContent = 'è¿½åŠ ä¸­...';

            try {
                await addDeck(deckName); 
                toggleModal(deckModal, false);
                showMessage(`ãƒ‡ãƒƒã‚­ã€Œ${deckName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, 'success');
            } catch (e) {
                console.error('ãƒ‡ãƒƒã‚­è¿½åŠ å¤±æ•—:', e);
                showMessage('ãƒ‡ãƒƒã‚­ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼çŠ¶æ…‹ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            } finally {
                // UIã‚’å…ƒã«æˆ»ã™
                deckModalAddBtn.textContent = 'è¿½åŠ ';
                // å…¥åŠ›å€¤ãŒç©ºã§ãªã‘ã‚Œã°ã€ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ã™ã‚‹ï¼ˆä»Šå›ã¯ã‚¯ãƒªã‚¢ã™ã‚‹ã®ã§ç„¡åŠ¹åŒ–ã®ã¾ã¾ï¼‰
                deckModalAddBtn.disabled = true; 
                newDeckNameInput.value = ''; // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            }
        });

        // ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒªã‚¹ãƒŠãƒ¼
        const chartsModalCloseBtn = document.getElementById('charts-modal-close-btn');

        openChartsModalBtn.addEventListener('click', () => {
             chartsModalTitle.textContent = `${decks.find(d => d.id === selectedDeckId)?.name || 'ãƒ‡ãƒƒã‚­'} ã®åˆ†æã‚°ãƒ©ãƒ•`;
             toggleModal(chartsModal, true);
             // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¨ãã«ã€ç¾åœ¨ã®ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’æç”»
             showChart(currentChartType); 
        });

        chartsModalCloseBtn.addEventListener('click', () => {
            destroyChartInstances(); // é–‰ã˜ã‚‹éš›ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            toggleModal(chartsModal, false);
        });

        chartTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const chartType = e.target.getAttribute('data-chart');
                showChart(chartType); // ã‚°ãƒ©ãƒ•æç”»ã‚’å®Ÿè¡Œ
            });
        });


        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        window.onload = initFirebaseAndAuth;
    </script>

</body>
</html>

